using Microsoft.EntityFrameworkCore;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Xml.Xsl;
using Telegram.Bot;
using Telegram.Bot.Exceptions;
using Telegram.Bot.Polling;
using Telegram.Bot.Types;
using Telegram.Bot.Types.Enums;
using Telegram.Bot.Types.ReplyMarkups;
using TelegramBot.Data;

namespace TelegramBot.TelegramAPI
{
    public enum ChatState : ushort
    {
        Standard = 0,
        GetEmail = 1,
        GetCode = 2,
        GetDoc = 3,
        GetTag = 4,
        GetData = 5,
        AskData = 6,
        Default = 7,
        WaitingForData = 8,
    }
    public struct Question
    {
        public ChatId Receiver;
        public string Message;
        public int PurchaseId;
        public string Answer;
        public string ReturnTag;

        public static Question New(ChatId chat, string message, int purchaseId)
        {
            return new Question() { Receiver = chat, Message = message, PurchaseId = purchaseId };
        }
    }
    public class TelegramBot
    {
        public long GroupId { get; set; } = -1002007072435;
        public static TelegramBot? CurrentBot { get;set; }
        public List<Message> PreviousMessages { get; set; } = new List<Message>();
        public List<Message> ToDelete { get; set; } = new List<Message>();
        public Dictionary<ChatId, int> CurrentPurchase { get; set; } = new Dictionary<ChatId, int>();
        public Dictionary<ChatId,Purchase> GoingToBuy { get;set;} = new Dictionary<ChatId,Purchase>();
        public Dictionary<ChatId, ChatState> ChatStates { get; set; } = new Dictionary<ChatId, ChatState>();
        public Dictionary<ChatId,Question> AskDataStates { get; set; } = new Dictionary<ChatId, Question>();
        public Dictionary<ChatId, List<Item>> Cart { get; set; } = new Dictionary<ChatId, List<Item>>();
        public BotDataContext Context { get; set; } = new BotDataContext();
        private readonly ITelegramBotClient _botClient;
        private readonly ReceiverOptions _receiverOptions;

        public TelegramBot(string token)
        {
            _botClient = new TelegramBotClient(token);
            TelegramRoutes.Bot = this;
            _receiverOptions = new ReceiverOptions
            {
                AllowedUpdates = new[]
                {
                    UpdateType.Message,
                    UpdateType.CallbackQuery,
                    UpdateType.ChannelPost,
                },
                ThrowPendingUpdates = true
            };
        }

        public async Task Start()
        {
            using var cts = new CancellationTokenSource();
            TelegramRoutes.Bot = this;
            _ = StartCleaning(60 * 60);
            
            _botClient.StartReceiving(
                updateHandler: HandleUpdateAsync,
                pollingErrorHandler: HandleErrorAsync,
                receiverOptions: _receiverOptions,
                cancellationToken: cts.Token
            );
            
            await Utils.Log("Bot started", ConsoleColor.DarkGreen);
            await Task.Delay(-1);
        }

        private async Task HandleUpdateAsync(ITelegramBotClient botClient, Update update, CancellationToken cancellationToken)
        {
            try
            {
                if (update.Type == UpdateType.CallbackQuery && update.CallbackQuery?.Data != null)
                {
                    await Utils.Log($"Callback query {update.CallbackQuery.Data}", ConsoleColor.DarkBlue);
                    await SetRoute(update.CallbackQuery.Data, update.CallbackQuery.Message?.Chat.Id ?? 0);
                    return;
                }

                if (update.Type == UpdateType.Message && update.Message?.Chat != null)
                {
                    if (update.Message.Chat.Id == GroupId) return;
                    
                    await Utils.Log($"Text message {update.Message.Chat.Id}", ConsoleColor.DarkBlue);
                    var updateMessage = update.Message.Text ?? string.Empty;
                    var chat = update.Message.Chat;

                    if (string.IsNullOrEmpty(updateMessage)) return;

                    if (!ChatStates.ContainsKey(chat.Id))
                    {
                        ChatStates[chat.Id] = ChatState.Default;
                    }

                    if (Utils.IsValidTelegramTag(updateMessage))
                    {
                        await SetRoute(updateMessage, chat.Id);
                        return;
                    }

                    if (ChatStates[chat.Id] == ChatState.Default)
                    {
                        await SetRoute("menu", chat.Id);
                        return;
                    }

                    if (ChatStates[chat.Id] == ChatState.WaitingForData)
                    {
                        if (!AskDataStates.ContainsKey(chat.Id))
                        {
                            ChatStates[chat.Id] = ChatState.Default;
                            await SetRoute("menu", chat.Id);
                            return;
                        }

                        var question = AskDataStates[chat.Id];
                        question.Answer = updateMessage;
                        await SetRoute(question.ReturnTag, chat.Id);
                        return;
                    }
                }
            }
            catch (Exception ex)
            {
                await Utils.Log($"Error in update handler: {ex.Message}", ConsoleColor.Red);
            }
        }

        private Task HandleErrorAsync(ITelegramBotClient botClient, Exception error, CancellationToken cancellationToken)
        {
            if (error is ApiRequestException apiRequestException)
            {
                return Utils.Log($"Telegram API Error:\n[{apiRequestException.ErrorCode}]\n{apiRequestException.Message}", ConsoleColor.Red);
            }
            
            return Utils.Log($"Error: {error.Message}", ConsoleColor.Red);
        }

        private async Task StartCleaning(int seconds)
        {
            while (true)
            {
                await Task.Delay(seconds * 1000);
                var toDelete = ToDelete.ToList();
                ToDelete.Clear();
                foreach (var message in toDelete)
                {
                    try
                    {
                        if (message?.Chat?.Id != null)
                        {
                            await _botClient.DeleteMessageAsync(message.Chat.Id, message.MessageId);
                        }
                    }
                    catch (Exception ex)
                    {
                        await Utils.Log($"Error deleting message: {ex.Message}", ConsoleColor.Red);
                    }
                }
            }
        }

        public async Task SetRoute(string route, ChatId chat)
        {
            await TelegramRoutes.GetRenderByRoute(route, _botClient, chat);
        }

        private static ReplyKeyboardMarkup GetMainKeyboard()
        {
            return new ReplyKeyboardMarkup(new[]
            {
                new[] 
                { 
                    KeyboardButton.WithWebApp("–û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω", 
                        new WebAppInfo { Url = "https://lancaaaster.github.io/lancaster-shop-webapp/" })
                }
            })
            {
                ResizeKeyboard = true
            };
        }

        public async Task ClearCart(ChatId chat, bool showMessage = true)
        {
            if (!Cart.ContainsKey(chat))
            {
                Cart[chat] = new List<Item>();
                if (showMessage)
                {
                    await SendEmptyCartMessage(chat, true);
                }
                return;
            }

            bool isEmpty = Cart[chat].Count == 0;
            Cart[chat].Clear();
            
            if (showMessage)
            {
                await SendEmptyCartMessage(chat, isEmpty);
            }
        }

        private async Task SendEmptyCartMessage(ChatId chat, bool wasEmpty)
        {
            var inlineKeyboard = new InlineKeyboardMarkup(
                new[]
                {
                    new[]
                    {
                        InlineKeyboardButton.WithCallbackData("–ù–∞–∑–∞–¥", "main"),
                    },
                });
            
            string message = "–ö–æ—Ä–∑–∏–Ω–∞ —Ç–µ–ø–µ—Ä—å –ø—É—Å—Ç–∞!" + (wasEmpty ? "\r\n–ù–æ –¥–æ —ç—Ç–æ–≥–æ –æ–Ω–∞ —Ç–æ–∂–µ –±—ã–ª–∞ –ø—É—Å—Ç–æ–π :(" : string.Empty);
            await _botClient.SendTextMessageAsync(chat, message, replyMarkup: inlineKeyboard);
        }

        public async Task HandleUpdate(Update update)
        {
            try
            {
                if (update.Message?.WebAppData != null)
                {
                    await HandleWebAppUpdate(update);
                    return;
                }

                if (update.Message?.Chat != null)
                {
                    if (update.Message.Text == "–ö–æ—Ä–∑–∏–Ω–∞")
                    {
                        await ShowCart(update.Message.Chat.Id);
                        return;
                    }
                    
                    if (update.Message.Text == "–ü–æ–º–æ—â—å")
                    {
                        await ShowHelp(update.Message.Chat.Id);
                        return;
                    }

                    await _botClient.SendTextMessageAsync(
                        update.Message.Chat.Id,
                        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Lancaster Games Shop! üéÆ\n\n" +
                        "–£ –Ω–∞—Å –≤—ã –Ω–∞–π–¥–µ—Ç–µ:\n" +
                        "üéØ –õ—É—á—à–∏–µ –∏–≥—Ä—ã –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º\n" +
                        "üíé –í–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã\n" +
                        "üéÅ –ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∫–∞—Ä—Ç—ã\n\n" +
                        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω:",
                        replyMarkup: GetKeyboard()
                    );
                    return;
                }
            }
            catch (Exception ex)
            {
                await Utils.Log($"Error in HandleUpdate: {ex.Message}", ConsoleColor.Red);
                if (update.Message?.Chat != null)
                {
                    await Owner.OwnerAPI.NotifyOnwers(_botClient, $"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–∞:\n{ex.Message}");
                }
            }
        }

        private ReplyKeyboardMarkup GetKeyboard()
        {
            return new ReplyKeyboardMarkup(new[]
            {
                new[] 
                { 
                    KeyboardButton.WithWebApp("–û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω", 
                        new WebAppInfo { Url = "https://lancaaaster.github.io/lancaster-shop-webapp/" })
                },
                new[] { new KeyboardButton("–ö–æ—Ä–∑–∏–Ω–∞") },
                new[] { new KeyboardButton("–ü–æ–º–æ—â—å") }
            })
            {
                ResizeKeyboard = true
            };
        }

        private async Task HandleWebAppUpdate(Update update)
        {
            if (update.Message?.WebAppData == null) return;

            try
            {
                var data = JsonConvert.DeserializeObject<dynamic>(update.Message.WebAppData.Data);
                
                if (data?.action == "checkout")
                {
                    decimal total = data.total;
                    var items = JsonConvert.DeserializeObject<List<dynamic>>(data.items.ToString());
                    
                    var purchase = await CreatePurchase(update.Message.Chat, total, items);
                    await NotifyUser(update.Message.Chat.Id, purchase, total);
                    await NotifyOwners(purchase);
                }
            }
            catch (Exception ex)
            {
                await Utils.Log($"Error in HandleWebAppUpdate: {ex.Message}", ConsoleColor.Red);
                if (update.Message?.Chat != null)
                {
                    await Owner.OwnerAPI.NotifyOnwers(_botClient, $"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–∞ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:\n{ex.Message}");
                }
            }
        }

        private async Task<Purchase> CreatePurchase(Chat chat, decimal total, List<dynamic> items)
        {
            var purchase = new Purchase
            {
                Identifier = await GenerateUniqueIdentifier(),
                IndexNumber = Context.Purchases.Count(),
                Cost = (ulong)total,
                CustomerID = chat.Id,
                CustomerName = chat.Username,
                PaymentSystem = "Web App",
                Goods = items.Select(item => ((string)item.id)).ToList(),
                Data = $"–ó–∞–∫–∞–∑ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:\n" + 
                       string.Join("\n", items.Select(item => $"- {(string)item.name}: {(decimal)item.price}‚ÇΩ"))
            };

            await Context.Purchases.AddAsync(purchase.ToDataModel());
            await Context.SaveChangesAsync();

            return purchase;
        }

        private async Task<int> GenerateUniqueIdentifier()
        {
            var identifier = new Random().Next();
            while (await Context.Purchases.AnyAsync(v => v.Identifier == identifier))
            {
                identifier = new Random().Next();
            }
            return identifier;
        }

        private async Task NotifyUser(ChatId chatId, Purchase purchase, decimal total)
        {
            await _botClient.SendTextMessageAsync(
                chatId,
                $"‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!\n" +
                $"üÜî –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {purchase.Identifier}\n" +
                $"üí∞ –°—É–º–º–∞: {total}‚ÇΩ\n" +
                $"üì¶ –¢–æ–≤–∞—Ä—ã:\n{purchase.Data}"
            );
        }

        private async Task NotifyOwners(Purchase purchase)
        {
            var inlineKeyboard = new InlineKeyboardMarkup(
                new[]
                {
                    new[]
                    {
                        InlineKeyboardButton.WithCallbackData("–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑—É", $"show|{purchase.Identifier}"),
                    },
                });

            await Owner.OwnerAPI.NotifyOnwers(_botClient, 
                $"üîî –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!\n" +
                $"üë§ –ó–∞–∫–∞–∑: {purchase.IndexNumber}, ID: {purchase.Identifier}\n" +
                $"üè¶ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: {purchase.PaymentSystem}\n" +
                $"üõç –¢–æ–≤–∞—Ä—ã:\n{Utils.GetGoodsString(purchase)}\n" +
                $"üí∞ –¶–µ–Ω–∞: {purchase.Cost}‚ÇΩ", 
                markup: inlineKeyboard);
        }

        private async Task ShowCart(ChatId chatId)
        {
            if (!Cart.ContainsKey(chatId) || Cart[chatId].Count == 0)
            {
                await _botClient.SendTextMessageAsync(
                    chatId,
                    "üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.\n" +
                    "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω', —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã.",
                    replyMarkup: GetKeyboard()
                );
                return;
            }

            var cartItems = Cart[chatId];
            var message = "üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞:\n\n";
            decimal total = 0;

            foreach (var item in cartItems)
            {
                message += $"‚Ä¢ {item.Name} - {item.Price}‚ÇΩ\n";
                total += item.Price;
            }

            message += $"\n–û–±—â–∞—è —Å—É–º–º–∞: {total}‚ÇΩ";

            await _botClient.SendTextMessageAsync(
                chatId,
                message,
                replyMarkup: GetKeyboard()
            );
        }

        private async Task ShowHelp(ChatId chatId)
        {
            await _botClient.SendTextMessageAsync(
                chatId,
                "‚ÑπÔ∏è –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞:\n\n" +
                "1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω' –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤\n" +
                "2. –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —Ç–æ–≤–∞—Ä—ã\n" +
                "3. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –∫–æ—Ä–∑–∏–Ω—É\n" +
                "4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞\n\n" +
                "–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ @support",
                replyMarkup: GetKeyboard()
            );
        }
    }
}
